<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <!-- 引入浏览器默认样式 -->
  <link rel="stylesheet" href="../css/reset.css">
  <!-- 引入MUI -->
  <link rel="stylesheet" href="../css/mui.min.css">
  <!-- 引入字体图标库 -->
  <link rel="stylesheet" href="../res/fontAwesome/css/font-awesome.min.css">
  <!-- 引入公共样式 -->
  <link rel="stylesheet" href="../css/common.css">
  <!-- 引入页面样式 -->
  <link rel="stylesheet" href="../css/detail.css">
  <title>乐淘云购-搜索中心</title>
  <!-- 引入网站图标 -->
  <!-- <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon"> -->
</head>

<body>

  <!-- 1.头部 -->
  <header class="lt-header mui-bar mui-bar-nav">
    <a id="lt-back" class="fa fa-arrow-left mui-pull-left" href="javascript:history.back();"></a>
    <a id="lt-home" class="fa fa-home mui-pull-right" href="../index.html"></a>
    <h1 class="mui-title">
      商品详情
    </h1>
  </header>
  <!-- 2.底部 -->
  <nav class="lt-footer mui-bar mui-bar-tab">
    <div class="lt-footer-container">
      <!-- 购物图标 -->
      <a href="javascript:;" class="add-cart  fa fa-shopping-cart"></a>
      <!-- 加入购物车 -->
      <a href="javascript:;" class="btn-cart">加入购物车</a>
      <!-- 立即购买 -->
      <a href="javascript:;" class="btn-buy">立即购买</a>
    </div>
  </nav>
  <!-- 3.主体 -->
  <main class="mui-content mui-scroll-wrapper" id="refreshContainer">
    <div class="mui-scroll">
      <!-- 轮播图 -->
      <div id="slider" class="mui-slider">
        <div class="mui-slider-group mui-slider-loop">
          <!-- 额外增加的一个节点(循环轮播：第一个节点是最后一张轮播) -->
          <div class="mui-slider-item mui-slider-item-duplicate">
            <a href="#">
              <img src="../img/banner2.png">
            </a>
          </div>
          <!-- 第一张 -->
          <div class="mui-slider-item">
            <a href="#">
              <img src="../img/banner1.png">
            </a>
          </div>
          <!-- 第二张 -->
          <div class="mui-slider-item">
            <a href="#">
              <img src="../img/banner2.png">
            </a>
          </div>
          <!-- 额外增加的一个节点(循环轮播：最后一个节点是第一张轮播) -->
          <div class="mui-slider-item mui-slider-item-duplicate">
            <a href="#">
              <img src="../img/banner1.png">
            </a>
          </div>
        </div>
        <div class="mui-slider-indicator">
          <div class="mui-indicator mui-active"></div>
          <div class="mui-indicator"></div>
        </div>
      </div>
      <!-- 商品名称 -->
      <p class="product-name">Sport飓风 Nike Kwazi 休闲运动鞋男 844839-002-001-100-400</p>
      <!-- 商品价格 -->
      <div class="product-price">
        <small>价格:</small>
        <span>&yen;499.1</span>
        <span>&yen;888.1</span>
      </div>
      <!-- 尺码 -->
      <div class="product-size">
        <small>尺码:</small>
        <span>30</span>
        <span>31</span>
        <span>32</span>
        <span>33</span>
        <span>34</span>
        <span>35</span>
        <span>36</span>
        <span>37</span>
        <span>38</span>
        <span>39</span>
        <span>40</span>
        <span>41</span>
        <span>42</span>
        <span>43</span>
        <span>44</span>
        <span>45</span>
      </div>
      <!-- 数量 -->
      <div class="product-number">
        <small>数量:</small>
        <div class="mui-numbox" data-numbox-min='0' data-numbox-max='100'>
          <button class="mui-btn mui-numbox-btn-minus" type="button">-</button>
          <input class="mui-numbox-input" type="number" />
          <button class="mui-btn mui-numbox-btn-plus" type="button">+</button>
        </div>
        <span>剩余: 20件</span>
      </div>
    </div>
  </main>



  <!-- 商品详情模板 -->
  <script type="text/template" id="detail-templ">
  <!-- 轮播图 -->
  <div id="slider" class="mui-slider">
      <div class="mui-slider-group mui-slider-loop">
        <!-- 额外增加的一个节点(循环轮播：第一个节点是最后一张轮播) -->
        
        <div class="mui-slider-item mui-slider-item-duplicate">
          <a href="#">
            <img src="<%=pic[pic.length-1].picAddr%>">
          </a>
        </div>
        <%for (var i = 0; i<pic.length; i++) {%>
          <div class="mui-slider-item">
              <a href="#">
                <img src="<%=pic[i].picAddr%>">
              </a>
            </div>
        <%}%>
        <!-- 额外增加的一个节点(循环轮播：最后一个节点是第一张轮播) -->
        <div class="mui-slider-item mui-slider-item-duplicate">
          <a href="#">
            <img src="<%=pic[0].picAddr%>">
          </a>
        </div>
      </div>
      <div class="mui-slider-indicator">
        <%for (var i = 0; i<pic.length; i++) {%>
            <%if (i == 0) {%>
            <div class="mui-indicator mui-active"></div>
            <%} else {%>
            <div class="mui-indicator"></div>
            <%}%>
            <%}%>
      </div>
    </div>
    <!-- 商品名称 -->
    <p class="product-name"><%=proName%></p>
    <!-- 商品价格 -->
    <div class="product-price">
      <small>价格:</small>
      <span>&yen;<%=price%></span>
      <span>&yen;<%=oldPrice%></span>
    </div>
    <!-- 尺码 -->
    <div class="product-size">
      <small>尺码:</small>
      <%for (var i = sizeArray[0]; i <= sizeArray[1]; i++) {%>
        <span><%=i%></span>
      <%}%>
    </div>
    <!-- 数量 -->
    <div class="product-number">
      <small>数量:</small>
      <div class="mui-numbox" data-numbox-min='1' data-numbox-max='<%=num%>'>
        <button class="mui-btn mui-numbox-btn-minus" type="button">-</button>
        <input class="mui-numbox-input" type="number" value="1" />
        <button class="mui-btn mui-numbox-btn-plus" type="button">+</button>
      </div>
      <span>剩余: <%=num%>件</span>
    </div>

</script>




  <!-- 引入zepto -->
  <script src="../libs/zepto/zepto.min.js"></script>
  <!-- 引入MUI -->
  <script src="../libs/mui/js/mui.js"></script>
  <!-- 引入模板引擎 -->
  <script src="../libs/artTemplate/template-native.js"></script>
  <!-- 引入首页js -->
  <script>
    mui.init({
      pullRefresh: {
        container: "#refreshContainer",//下拉刷新容器标识，querySelector能定位的css选择器均可，比如：id、.class等
        down: {
          height: 50,//可选,默认50.触发下拉刷新拖动距离,
          auto: true,//可选,默认false.首次加载自动下拉刷新一次
          contentdown: "下拉可以刷新",//可选，在下拉可刷新状态时，下拉刷新控件上显示的标题内容
          contentover: "释放立即刷新",//可选，在释放可刷新状态时，下拉刷新控件上显示的标题内容
          contentrefresh: "正在刷新...",//可选，正在刷新状态时，下拉刷新控件上显示的标题内容
          callback: function () {
            setTimeout(function () {
              mui('#refreshContainer').pullRefresh().endPulldownToRefresh();
            }, 1000)
          } //必选，刷新函数，根据具体业务来编写，比如通过ajax从服务器获取新数据；
        }
      }
    });
    $(function () {
      var url = new URLSearchParams(location.search);
      var id = url.get('id');
      // console.log(id);
      getDetaileData(id);
      $('.mui-content ').on('tap','.product-size span',function(){
        $('.product-size span').removeClass('active');
        $(this).addClass('active');
      });
      $('.btn-cart').on('tap', function () {
        // alert(id);
        var num = mui('.mui-numbox').numbox().getValue();
        var size = $(".product-size span.active").text();
        if(!id){
          mui.toast('该商品无货！');
        }else if(!size){
          mui.toast('请选择尺码');
        }else if(!num){
          mui.toast('请选择数量');
        }else{
          setProduct(id,num,size);
        }
      });
    });
    var getDetaileData = function (id) {
      $.ajax({
        url: '/product/queryProductDetail',
        data: { id: id },
        type: 'GET',
        success: function (data) {
          // console.log(data);
          var size = data.size.split('-');
          data.sizeArray = size;
          // console.log(data);
          var html = template('detail-templ', data);
          // console.log(html);
          $('.mui-scroll').html(html);
          // 模板渲染完之后，重新初始化轮播图
          var gallery = mui('.mui-slider');
          gallery.slider({
            interval: 3000//自动轮播周期，若为0则不自动播放，默认为0；
          });
          // 模板渲染完之后，重新初始化数字输入框
          mui('.mui-numbox').numbox()
        }
      });
    }
    var setProduct=function(id,num,size){
     $.ajax({
       url:'/cart/addCart',
       data:{productId:id,num:num,size:size},
       type:'post',
       success:function(data){
         console.log(data);
        if(data.error==400){
          var url=location.href;
          location.href="../login.html?url="+url;
        }
        if(data.success){
          mui.confirm('是否跳转到购物车','提示',['确定','取消'],function(e){
           if(e.index==0){
            location.href="../cart.html";
           }else{
            //  无需求  先留着
           }
          });
        }
       }
     });
    }
  </script>
</body>

</html>